<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</title>

<style>
body {
    margin: 0;
    font-family: Tahoma, Arial, sans-serif;
    background: #f5f7fa;
    color: #333;
}

header {
    text-align: center;
    border-bottom: 3px solid #0a3cff;
    padding: 15px;
    background: #fff;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

header img {
    height: 90px;
}

#datetime {
    font-size: 22px;
    font-weight: bold;
    margin-top: 10px;
    color: #0a3cff;
}

.container {
    max-width: 1000px;
    margin: auto;
    padding: 20px;
}

input, textarea, select {
    width: 100%;
    padding: 14px;
    margin: 8px 0;
    font-size: 18px;
    border: 1px solid #ddd;
    border-radius: 6px;
    box-sizing: border-box;
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: #0a3cff;
    box-shadow: 0 0 5px rgba(10, 60, 255, 0.3);
}

button {
    width: 100%;
    padding: 14px;
    margin: 10px 0;
    font-size: 20px;
    background: #0a3cff;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

button:hover {
    background: #0834d4;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(10, 60, 255, 0.2);
}

.hidden {
    display: none !important;
}

.card {
    border: 2px solid #0a3cff;
    border-radius: 8px;
    margin: 15px 0;
    background: #fff;
    overflow: hidden;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.card-header {
    padding: 18px;
    font-size: 22px;
    background: #f3f6ff;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}

.card-body {
    display: none;
    padding: 20px;
    font-size: 18px;
    border-top: 1px solid #eee;
}

.plate {
    border: 2px solid #000;
    padding: 10px 20px;
    font-size: 24px;
    font-weight: bold;
    display: inline-block;
    margin-bottom: 15px;
    background: #fff;
    border-radius: 6px;
}

.warn {
    color: #ff0000;
    font-weight: bold;
    background: #fff0f0;
    padding: 10px;
    border-radius: 6px;
    margin: 10px 0;
    border-right: 4px solid #ff0000;
}

.info {
    color: #0a3cff;
    font-weight: bold;
    background: #f3f6ff;
    padding: 10px;
    border-radius: 6px;
    margin: 10px 0;
    border-right: 4px solid #0a3cff;
}

footer {
    text-align: center;
    border-top: 2px solid #0a3cff;
    padding: 20px;
    font-size: 18px;
    background: #fff;
    margin-top: 30px;
}

.iconBtn {
    width: auto;
    padding: 10px 20px;
    margin: 8px 5px;
    font-size: 16px;
    border-radius: 6px;
    display: inline-block;
}

.printBtn {
    background: #28a745;
}

.printBtn:hover {
    background: #218838;
}

.deleteBtn {
    background: #dc3545;
}

.deleteBtn:hover {
    background: #c82333;
}

.editBtn {
    background: #ffc107;
    color: #000;
}

.editBtn:hover {
    background: #e0a800;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #555;
}

.form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.form-row .form-group {
    flex: 1;
}

.stats {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
    padding: 15px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.stat-item {
    text-align: center;
    padding: 10px;
}

.stat-value {
    font-size: 28px;
    font-weight: bold;
    color: #0a3cff;
}

.stat-label {
    font-size: 14px;
    color: #666;
}

#searchBox {
    margin: 20px 0;
    position: relative;
}

#searchBox input {
    padding: 14px 50px 14px 14px;
    border-radius: 30px;
}

#searchBox::before {
    content: "ğŸ”";
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    color: #777;
}

#logoutBtn {
    position: absolute;
    left: 20px;
    top: 20px;
    width: auto;
    padding: 8px 20px;
    font-size: 16px;
    background: #6c757d;
}

#logoutBtn:hover {
    background: #5a6268;
}

@media (max-width: 768px) {
    .form-row {
        flex-direction: column;
        gap: 0;
    }
    
    .container {
        padding: 10px;
    }
    
    .card-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .stats {
        flex-direction: column;
    }
    
    #logoutBtn {
        position: relative;
        left: 0;
        top: 0;
        margin-bottom: 15px;
    }
}
</style>
</head>

<body>

<header>
    <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…">
    <div id="datetime"></div>
</header>

<div class="container">

    <!-- LOGIN -->
    <div id="loginBox">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <div class="form-group">
            <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input id="email" type="email" placeholder="example@email.com">
        </div>
        <div class="form-group">
            <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="password" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        </div>
        <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
        <button id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h2>
        
        <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="totalCars">0</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="expiringSoon">0</div>
                <div class="stat-label">ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lastId">UAE100</div>
                <div class="stat-label">Ø¢Ø®Ø± Ù…Ø¹Ø±Ù</div>
            </div>
        </div>
        
        <!-- Ø§Ù„Ø¨Ø­Ø« -->
        <div id="searchBox">
            <input id="searchInput" type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø¹Ø±Ù Ø£Ùˆ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©..." onkeyup="searchCars()">
        </div>
        
        <!-- Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø© -->
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="openForm()" style="width: auto; padding: 12px 30px;">â• Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø© -->
        <div id="carForm" class="hidden">
            <div style="background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 20px 0;">
                <h3 style="margin-top: 0; color: #0a3cff;">Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="plateCode">Ø±Ù…Ø² Ø§Ù„Ù„ÙˆØ­Ø©</label>
                        <select id="plateCode">
                            <option value="">Ø§Ø®ØªØ± Ø±Ù…Ø² Ø§Ù„Ù„ÙˆØ­Ø©</option>
                            <option value="Ø£Ø¨Ùˆ Ø¸Ø¨ÙŠ">Ø£Ø¨Ùˆ Ø¸Ø¨ÙŠ</option>
                            <option value="Ø¯Ø¨ÙŠ">Ø¯Ø¨ÙŠ</option>
                            <option value="Ø§Ù„Ø´Ø§Ø±Ù‚Ø©">Ø§Ù„Ø´Ø§Ø±Ù‚Ø©</option>
                            <option value="Ø¹Ø¬Ù…Ø§Ù†">Ø¹Ø¬Ù…Ø§Ù†</option>
                            <option value="Ø£Ù… Ø§Ù„Ù‚ÙŠÙˆÙŠÙ†">Ø£Ù… Ø§Ù„Ù‚ÙŠÙˆÙŠÙ†</option>
                            <option value="Ø±Ø£Ø³ Ø§Ù„Ø®ÙŠÙ…Ø©">Ø±Ø£Ø³ Ø§Ù„Ø®ÙŠÙ…Ø©</option>
                            <option value="Ø§Ù„ÙØ¬ÙŠØ±Ø©">Ø§Ù„ÙØ¬ÙŠØ±Ø©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="plateNumber">Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</label>
                        <input id="plateNumber" placeholder="Ù…Ø«Ø§Ù„: 12345">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="owner">Ø§Ù„Ù…Ø§Ù„Ùƒ</label>
                        <input id="owner" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ">
                    </div>
                    <div class="form-group">
                        <label for="user">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                        <input id="user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="type">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                        <input id="type" placeholder="Ù…Ø«Ø§Ù„: ØªÙˆÙŠÙˆØªØ§ ÙƒØ§Ù…Ø±ÙŠ">
                    </div>
                    <div class="form-group">
                        <label for="year">Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹</label>
                        <input id="year" type="number" placeholder="Ù…Ø«Ø§Ù„: 2022" min="1990" max="2024">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="licenseEnd">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ±Ø®ÙŠØµ</label>
                        <input id="licenseEnd" type="date">
                    </div>
                    <div class="form-group">
                        <label for="insuranceEnd">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†</label>
                        <input id="insuranceEnd" type="date">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea id="notes" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..." rows="3"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <button onclick="saveCar()" style="background: #28a745;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</button>
                    </div>
                    <div class="form-group">
                        <button onclick="closeForm()" style="background: #6c757d;">âœ– Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
                
                <div class="info" id="generatedIdInfo" style="display: none;">
                    Ø³ÙˆÙ ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù Ø«Ø§Ø¨Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø³ÙŠØ§Ø±Ø© (Ù…Ø«Ø§Ù„: UAE101)
                </div>
            </div>
        </div>

        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª -->
        <div id="carsList"></div>
    </div>
</div>

<footer>Â© Developed by Mohamed Saad - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { 
    getAuth, 
    signInWithEmailAndPassword, 
    onAuthStateChanged,
    signOut 
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { 
    getFirestore, 
    collection, 
    deleteDoc, 
    doc, 
    onSnapshot,
    setDoc,
    getDoc,
    updateDoc,
    query,
    orderBy,
    getDocs
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// ØªÙ‡ÙŠØ¦Ø© Firebase
const app = initializeApp({
    apiKey: "AIzaSyCvrNKiue6lIvJVkgFXWwiYMEY3rWdmj4g",
    authDomain: "my-car123.firebaseapp.com",
    projectId: "my-car123",
    storageBucket: "my-car123.firebasestorage.app",
    messagingSenderId: "731889650556",
    appId: "1:731889650556:web:9c1fb521647131f48db2f9"
});

const auth = getAuth(app);
const db = getFirestore(app);

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
let printContent = "";
let allCars = [];
let lastCarId = 100;

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
window.login = () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    
    if (!email || !password) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
        return;
    }
    
    signInWithEmailAndPassword(auth, email, password)
    .then(() => {
        alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­");
    })
    .catch(e => {
        alert("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e.message);
    });
};

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
window.logout = () => {
    if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
        signOut(auth)
        .then(() => {
            alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
        })
        .catch(e => {
            alert("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: " + e.message);
        });
    }
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
onAuthStateChanged(auth, user => {
    if (user) {
        document.getElementById("loginBox").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        loadCars();
        updateStats();
    } else {
        document.getElementById("loginBox").classList.remove("hidden");
        document.getElementById("dashboard").classList.add("hidden");
    }
});

// ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
window.openForm = () => {
    document.getElementById("carForm").classList.remove("hidden");
    document.getElementById("generatedIdInfo").style.display = "block";
    document.getElementById("searchBox").style.display = "none";
};

window.closeForm = () => {
    document.getElementById("carForm").classList.add("hidden");
    document.getElementById("generatedIdInfo").style.display = "none";
    document.getElementById("searchBox").style.display = "block";
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById("plateCode").value = "";
    document.getElementById("plateNumber").value = "";
    document.getElementById("owner").value = "";
    document.getElementById("user").value = "";
    document.getElementById("type").value = "";
    document.getElementById("year").value = "";
    document.getElementById("licenseEnd").value = "";
    document.getElementById("insuranceEnd").value = "";
    document.getElementById("notes").value = "";
};

// ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù Ø«Ø§Ø¨Øª Ù„Ù„Ø³ÙŠØ§Ø±Ø©
window.generateCarId = async () => {
    try {
        // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ù…Ø¹Ø±Ù ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ§Ù„ÙŠ
        const carsRef = collection(db, "cars");
        const q = query(carsRef, orderBy("carId", "desc"));
        const snapshot = await getDocs(q);
        
        let newId = 100; // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
        
        if (!snapshot.empty) {
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ù…Ø¹Ø±Ù
            const lastCar = snapshot.docs[0].data();
            if (lastCar.carId) {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ù‚Ù… Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ù (Ù…Ø«Ø§Ù„: UAE101 -> 101)
                const lastIdNum = parseInt(lastCar.carId.replace("UAE", ""));
                newId = lastIdNum + 1;
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø¹Ø±ÙØ§ØªØŒ Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¹Ù„Ù‰ Ø±Ù‚Ù…
                let maxId = 99;
                snapshot.forEach(doc => {
                    const carData = doc.data();
                    if (carData.carId) {
                        const idNum = parseInt(carData.carId.replace("UAE", ""));
                        if (idNum > maxId) maxId = idNum;
                    }
                });
                newId = maxId + 1;
            }
        }
        
        lastCarId = newId;
        return `UAE${newId}`;
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø±Ù:", error);
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        return `UAE${Date.now().toString().slice(-6)}`;
    }
};

// Ø­ÙØ¸ Ø§Ù„Ø³ÙŠØ§Ø±Ø©
window.saveCar = async () => {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    if (!document.getElementById("plateCode").value || !document.getElementById("plateNumber").value) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² ÙˆØ±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©");
        return;
    }
    
    if (!document.getElementById("owner").value) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ");
        return;
    }
    
    try {
        // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù Ø«Ø§Ø¨Øª Ù„Ù„Ø³ÙŠØ§Ø±Ø©
        const carId = await generateCarId();
        
        // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©
        const carData = {
            carId: carId,
            plate: `${document.getElementById("plateCode").value} ${document.getElementById("plateNumber").value}`,
            owner: document.getElementById("owner").value,
            user: document.getElementById("user").value || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
            type: document.getElementById("type").value || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
            year: document.getElementById("year").value || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
            licenseEnd: document.getElementById("licenseEnd").value || "",
            insuranceEnd: document.getElementById("insuranceEnd").value || "",
            notes: document.getElementById("notes").value || "",
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        // Ø­ÙØ¸ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙÙŠ Firestore Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø±Ù ÙƒÙ…Ø¹Ø±Ù Ù„Ù„Ù…Ø³ØªÙ†Ø¯
        await setDoc(doc(db, "cars", carId), carData);
        
        alert(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­!\nØ§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø«Ø§Ø¨Øª: ${carId}`);
        closeForm();
        updateStats();
    } catch (error) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: " + error.message);
        console.error(error);
    }
};

// Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø©
window.deleteCar = async (id) => {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")) {
        try {
            await deleteDoc(doc(db, "cars", id));
            alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­");
            updateStats();
        } catch (error) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + error.message);
        }
    }
};

// Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©
window.printCar = (html) => {
    const w = window.open("", "", "width=800,height=600");
    w.document.write(`
        <html>
        <head>
            <title>Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                .print-card { border: 2px solid #000; padding: 20px; margin: 20px; }
                .print-title { text-align: center; font-size: 24px; margin-bottom: 20px; }
                .print-info { margin-bottom: 10px; }
                .print-label { font-weight: bold; }
            </style>
        </head>
        <body>
            <div class="print-card">
                <div class="print-title">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</div>
                ${html}
                <hr>
                <div style="text-align: center; margin-top: 20px; font-size: 12px;">
                    ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ: ${new Date().toLocaleString('ar-SA')}
                </div>
            </div>
        </body>
        </html>
    `);
    w.document.close();
    w.print();
    w.close();
};

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
window.searchCars = () => {
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();
    const filteredCars = allCars.filter(car => {
        return (
            car.carId.toLowerCase().includes(searchTerm) ||
            car.plate.toLowerCase().includes(searchTerm) ||
            car.owner.toLowerCase().includes(searchTerm) ||
            car.type.toLowerCase().includes(searchTerm)
        );
    });
    
    displayCars(filteredCars);
};

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
function loadCars() {
    const carsRef = collection(db, "cars");
    
    onSnapshot(carsRef, (snapshot) => {
        allCars = [];
        snapshot.forEach((doc) => {
            const carData = doc.data();
            carData.id = doc.id;
            allCars.push(carData);
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateStats();
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
        displayCars(allCars);
    });
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
function displayCars(cars) {
    const carsList = document.getElementById("carsList");
    
    if (cars.length === 0) {
        carsList.innerHTML = `
            <div style="text-align: center; padding: 40px; background: #fff; border-radius: 8px;">
                <h3 style="color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª</h3>
                <p>Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.</p>
            </div>
        `;
        return;
    }
    
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø±Ù
    cars.sort((a, b) => {
        const aNum = parseInt(a.carId?.replace("UAE", "") || 0);
        const bNum = parseInt(b.carId?.replace("UAE", "") || 0);
        return bNum - aNum; // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
    });
    
    carsList.innerHTML = "";
    
    cars.forEach((car) => {
        const now = new Date();
        const licEnd = car.licenseEnd ? new Date(car.licenseEnd) : null;
        const insEnd = car.insuranceEnd ? new Date(car.insuranceEnd) : null;
        
        let licenseWarning = "";
        let insuranceWarning = "";
        
        if (licEnd) {
            const diff = Math.ceil((licEnd - now) / (1000 * 60 * 60 * 24));
            if (diff <= 15 && diff > 0) {
                licenseWarning = `<div class="warn">âš ï¸ Ø§Ù„ØªØ±Ø®ÙŠØµ ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ ${diff} ÙŠÙˆÙ…</div>`;
            } else if (diff <= 0) {
                licenseWarning = `<div class="warn">âŒ Ø§Ù„ØªØ±Ø®ÙŠØµ Ù…Ù†ØªÙ‡ÙŠ Ù…Ù†Ø° ${Math.abs(diff)} ÙŠÙˆÙ…</div>`;
            }
        }
        
        if (insEnd) {
            const diff = Math.ceil((insEnd - now) / (1000 * 60 * 60 * 24));
            if (diff <= 15 && diff > 0) {
                insuranceWarning = `<div class="warn">âš ï¸ Ø§Ù„ØªØ£Ù…ÙŠÙ† ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ ${diff} ÙŠÙˆÙ…</div>`;
            } else if (diff <= 0) {
                insuranceWarning = `<div class="warn">âŒ Ø§Ù„ØªØ£Ù…ÙŠÙ† Ù…Ù†ØªÙ‡ÙŠ Ù…Ù†Ø° ${Math.abs(diff)} ÙŠÙˆÙ…</div>`;
            }
        }
        
        const cardHTML = `
            <div>
                <div class="plate">${car.plate || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</div>
                <div class="info">
                    <strong>Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø«Ø§Ø¨Øª:</strong> ${car.carId || car.id}
                </div>
                <strong>Ø§Ù„Ù…Ø§Ù„Ùƒ:</strong> ${car.owner || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}<br>
                <strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${car.user || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}<br>
                <strong>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> ${car.type || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}<br>
                <strong>Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹:</strong> ${car.year || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}<br>
                <strong>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ±Ø®ÙŠØµ:</strong> ${car.licenseEnd || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}<br>
                <strong>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†:</strong> ${car.insuranceEnd || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}<br>
                ${car.notes ? `<strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${car.notes}<br>` : ''}
                ${licenseWarning}
                ${insuranceWarning}
            </div>`;
            
        carsList.innerHTML += `
            <div class="card" id="car-${car.carId || car.id}">
                <div class="card-header">
                    <span>${car.carId || car.id} - ${car.plate || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</span>
                    <span style="font-size: 18px; color: #666;">${car.owner || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</span>
                </div>
                <div class="card-body">
                    ${cardHTML}
                    <div style="margin-top: 20px; text-align: left;">
                        <button class="iconBtn printBtn" onclick="printCar(\`${cardHTML.replace(/`/g, '\\`')}\`)">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
                        <button class="iconBtn deleteBtn" onclick="deleteCar('${car.carId || car.id}')">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø©</button>
                    </div>
                </div>
            </div>`;
    });
    
    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ù„Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    document.querySelectorAll(".card-header").forEach((header) => {
        header.onclick = () => {
            const body = header.nextElementSibling;
            body.style.display = body.style.display === "block" ? "none" : "block";
        };
    });
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
function updateStats() {
    document.getElementById("totalCars").textContent = allCars.length;
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙŠ ØªÙ†ØªÙ‡ÙŠ ØªØ±Ø§Ø®ÙŠØµÙ‡Ø§ Ù‚Ø±ÙŠØ¨Ø§Ù‹
    const now = new Date();
    const expiringSoon = allCars.filter(car => {
        if (!car.licenseEnd) return false;
        const licEnd = new Date(car.licenseEnd);
        const diff = Math.ceil((licEnd - now) / (1000 * 60 * 60 * 24));
        return diff <= 15 && diff > 0;
    }).length;
    
    document.getElementById("expiringSoon").textContent = expiringSoon;
    
    // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ù…Ø¹Ø±Ù
    if (allCars.length > 0) {
        const lastCar = allCars.sort((a, b) => {
            const aNum = parseInt(a.carId?.replace("UAE", "") || 0);
            const bNum = parseInt(b.carId?.replace("UAE", "") || 0);
            return bNum - aNum;
        })[0];
        
        document.getElementById("lastId").textContent = lastCar.carId || "UAE100";
    } else {
        document.getElementById("lastId").textContent = "UAE100";
    }
    
    // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
    if (expiringSoon > 0) {
        document.getElementById("expiringSoon").style.color = "#dc3545";
    } else {
        document.getElementById("expiringSoon").style.color = "#0a3cff";
    }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
setInterval(() => {
    const now = new Date();
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
    };
    
    document.getElementById("datetime").innerText = 
        now.toLocaleDateString('ar-SA', options);
}, 1000);
</script>

</body>
</html>